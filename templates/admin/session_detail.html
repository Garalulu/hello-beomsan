{% extends 'base.html' %}

{% block title %}Session Details{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-trophy"></i> Session Details</h1>
            <a href="{% url 'tournament_manage' %}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left"></i> <span class="d-none d-sm-inline">Back to Dashboard</span><span class="d-sm-none">Back</span>
            </a>
        </div>
    </div>
</div>

<!-- Session Info -->
<div class="row mb-4 g-3">
    <div class="col-12 col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> Session Information</h5>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-md-6">
                        <strong>User:</strong>
                        {% if session.user %}
                            <div class="mt-1">
                                <i class="fas fa-user"></i> {{ session.user.username }}
                                {% if session.user.profile %}
                                <br><small class="text-muted">osu!: {{ session.user.profile.osu_username }}</small>
                                {% endif %}
                            </div>
                        {% else %}
                            <div class="mt-1">
                                <i class="fas fa-user-secret"></i> Anonymous
                                <br><small class="text-muted">Session: {{ session.session_key }}</small>
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <strong>Status:</strong>
                        <div class="mt-1">
                            {% if session.status == 'COMPLETED' %}
                                <span class="badge bg-success"><i class="fas fa-check"></i> Completed</span>
                            {% elif session.status == 'ACTIVE' %}
                                <span class="badge bg-primary"><i class="fas fa-play"></i> Active</span>
                            {% elif session.status == 'ABANDONED' %}
                                <span class="badge bg-warning"><i class="fas fa-times"></i> Abandoned</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <strong>Started:</strong>
                        <div class="mt-1">{{ session.created_at|date:"M d, Y H:i" }}</div>
                    </div>
                    <div class="col-md-6">
                        <strong>Last Updated:</strong>
                        <div class="mt-1">{{ session.updated_at|date:"M d, Y H:i" }}</div>
                    </div>
                </div>
                {% if session.status == 'ACTIVE' %}
                <div class="row mt-3">
                    <div class="col-md-6">
                        <strong>Current Round:</strong>
                        <div class="mt-1">
                            <span class="badge bg-primary">{{ session.get_round_name }}</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <strong>Progress:</strong>
                        <div class="mt-1">{{ session.get_match_progress }}</div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    {% if winner_song %}
    <div class="col-12 col-lg-4">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h5><i class="fas fa-crown"></i> Tournament Winner</h5>
            </div>
            <div class="card-body text-center">
                {% if winner_song.background_image_url %}
                <img src="{{ winner_song.background_image_url }}" class="img-fluid rounded mb-3" style="max-height: 150px; max-width: 100%;">
                {% endif %}
                <h6>{{ winner_song.title }}</h6>
                {% if winner_song.original_song %}
                <p class="text-muted">Original: {{ winner_song.original_song }}</p>
                {% endif %}
                <button class="btn btn-sm btn-outline-primary" onclick="testAudio('{{ winner_song.audio_url }}')">
                    <i class="fas fa-play"></i> <span class="d-none d-sm-inline">Play</span>
                </button>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Match History -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-list"></i> Match History</h5>
            </div>
            <div class="card-body">
                {% if matches %}
                {% regroup matches by round_number as round_groups %}
                {% for round_group in round_groups %}
                <div class="mb-4">
                    <h6 class="border-bottom pb-2">
                        {% if round_group.grouper == 1 %}
                            <i class="fas fa-trophy text-warning"></i> Final
                        {% elif round_group.grouper == 2 %}
                            <i class="fas fa-medal text-silver"></i> Semi-Final
                        {% elif round_group.grouper == 3 %}
                            <i class="fas fa-award text-bronze"></i> Quarter-Final
                        {% else %}
                            <i class="fas fa-circle"></i> Round {{ round_group.grouper }}
                        {% endif %}
                    </h6>
                    
                    <div class="row">
                        {% for match in round_group.list %}
                        <div class="col-12 col-lg-6 mb-3">
                            <div class="card border-light">
                                <div class="card-body p-3">
                                    <div class="row g-1">
                                        <div class="col-5">
                                            <div class="text-center p-2 {% if match.winner == match.song1 %}bg-success text-white{% endif %} rounded">
                                                <div class="fw-bold">{{ match.song1.title|truncatechars:15 }}</div>
                                                {% if match.song1.original_song %}
                                                <small class="d-none d-sm-block">{{ match.song1.original_song|truncatechars:12 }}</small>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-2 text-center align-self-center px-1">
                                            <small class="fw-bold">VS</small>
                                        </div>
                                        <div class="col-5">
                                            <div class="text-center p-2 {% if match.winner == match.song2 %}bg-success text-white{% endif %} rounded">
                                                <div class="fw-bold">{{ match.song2.title|truncatechars:15 }}</div>
                                                {% if match.song2.original_song %}
                                                <small class="d-none d-sm-block">{{ match.song2.original_song|truncatechars:12 }}</small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% if match.winner %}
                                    <div class="text-center mt-2">
                                        <small class="text-muted">Winner: <strong>{{ match.winner.title }}</strong></small>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-list fa-3x text-muted mb-3"></i>
                    <h5>No Matches Found</h5>
                    <p class="text-muted">This session has no match history.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Audio Test Modal -->
<div class="modal fade" id="audioTestModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Test Audio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <audio id="testAudio" controls class="w-100">
                    Your browser does not support the audio element.
                </audio>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function testAudio(audioUrl) {
    const audio = document.getElementById('testAudio');
    audio.src = audioUrl;
    
    const modal = new bootstrap.Modal(document.getElementById('audioTestModal'));
    modal.show();
    
    // Pause audio when modal is hidden
    document.getElementById('audioTestModal').addEventListener('hidden.bs.modal', function () {
        audio.pause();
    });
}
</script>
{% endblock %}