{% extends 'base.html' %}

{% block title %}Tournament Management{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-trophy"></i> Tournament Management</h1>
            <a href="{% url 'tournament_history' %}" class="btn btn-outline-primary">
                <i class="fas fa-history"></i> View Full History
            </a>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="h4">{{ stats.total_active }}</div>
                        <div>Active Sessions</div>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-play-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="h4">{{ stats.total_completed }}</div>
                        <div>Completed Sessions</div>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="h4">{{ stats.total_abandoned }}</div>
                        <div>Abandoned Sessions</div>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-times-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Active & Abandoned Sessions -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-list"></i> Current Sessions ({{ active_abandoned_sessions.count }})</h5>
            </div>
            <div class="card-body">
                {% if active_abandoned_sessions %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>User</th>
                                <th>Round</th>
                                <th>Match Progress</th>
                                <th>Started</th>
                                <th>Last Updated</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for session in active_abandoned_sessions %}
                            <tr{% if session.status == 'ABANDONED' %} class="table-warning"{% endif %}>
                                <td>
                                    {% if session.status == 'ACTIVE' %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-play"></i> Active
                                        </span>
                                    {% elif session.status == 'ABANDONED' %}
                                        <span class="badge bg-warning">
                                            <i class="fas fa-times"></i> Abandoned
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if session.user %}
                                        <i class="fas fa-user"></i> {{ session.user.username }}
                                        {% if session.user.profile %}
                                        <br><small class="text-muted">{{ session.user.profile.osu_username }}</small>
                                        {% endif %}
                                    {% else %}
                                        <i class="fas fa-user-secret"></i> Anonymous
                                        <br><small class="text-muted">{{ session.session_key|truncatechars:10 }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if session.status == 'ACTIVE' %}
                                        <span class="badge bg-primary">{{ session.get_round_name }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ session.get_round_name }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if session.status == 'ACTIVE' %}
                                        {{ session.get_match_progress }}
                                        <div class="progress mt-1" style="height: 5px;">
                                            {% with progress=session.calculate_progress %}
                                            <div class="progress-bar" role="progressbar" style="width: {{ progress.percentage }}%"></div>
                                            {% endwith %}
                                        </div>
                                    {% else %}
                                        <span class="text-muted">{{ session.get_match_progress }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ session.created_at|date:"M d, H:i" }}</td>
                                <td>{{ session.updated_at|date:"M d, H:i" }}</td>
                                <td>
                                    <a href="{% url 'session_detail' session.id %}" class="btn btn-sm {% if session.status == 'ACTIVE' %}btn-outline-primary{% else %}btn-outline-secondary{% endif %}">
                                        <i class="fas fa-eye"></i> View
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-list fa-3x text-muted mb-3"></i>
                    <h5>No Current Sessions</h5>
                    <p class="text-muted">No active or abandoned tournaments found.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Recent Completed Sessions -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-check-circle text-success"></i> Recent Completed Sessions</h5>
            </div>
            <div class="card-body">
                {% if completed_sessions %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Completed</th>
                                <th>Duration</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for session in completed_sessions %}
                            <tr>
                                <td>
                                    {% if session.user %}
                                        <i class="fas fa-user"></i> {{ session.user.username }}
                                        {% if session.user.profile %}
                                        <br><small class="text-muted">{{ session.user.profile.osu_username }}</small>
                                        {% endif %}
                                    {% else %}
                                        <i class="fas fa-user-secret"></i> Anonymous
                                        <br><small class="text-muted">{{ session.session_key|truncatechars:10 }}</small>
                                    {% endif %}
                                </td>
                                <td>{{ session.updated_at|date:"M d, H:i" }}</td>
                                <td>
                                    {% with duration=session.updated_at|timeuntil:session.created_at %}
                                    {{ duration }}
                                    {% endwith %}
                                </td>
                                <td>
                                    <a href="{% url 'session_detail' session.id %}" class="btn btn-sm btn-outline-success">
                                        <i class="fas fa-trophy"></i> View Winner
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-check-circle fa-3x text-muted mb-3"></i>
                    <h5>No Completed Sessions</h5>
                    <p class="text-muted">No tournaments have been completed yet.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Real-time tournament manage updates
let updateInterval;
let isPageVisible = true;

// Track page visibility to pause updates when page is hidden
document.addEventListener('visibilitychange', function() {
    isPageVisible = !document.hidden;
    if (isPageVisible) {
        startRealTimeUpdates();
    } else {
        stopRealTimeUpdates();
    }
});

function startRealTimeUpdates() {
    // Clear existing interval
    if (updateInterval) {
        clearInterval(updateInterval);
    }
    
    // Update every 5 seconds
    updateInterval = setInterval(checkForUpdates, 5000);
}

function stopRealTimeUpdates() {
    if (updateInterval) {
        clearInterval(updateInterval);
        updateInterval = null;
    }
}

async function checkForUpdates() {
    if (!isPageVisible) return;
    
    try {
        const url = '{% url "tournament_manage_ajax" %}' + '?t=' + Date.now();
        const response = await fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        
        if (!response.ok) throw new Error('Network response was not ok');
        
        const data = await response.json();
        
        if (!data.success) {
            return;
        }
        
        // Update statistics cards
        updateStatsCards(data.stats);
        
        // Update session tables
        updateSessionTable('active-abandoned', data.active_abandoned_sessions);
        
        if (data.completed_sessions.length > 0) {
            updateSessionTable('completed', data.completed_sessions);
        }
        
    } catch (error) {
        console.error('Error checking for tournament updates:', error);
    }
}

function updateStatsCards(stats) {
    // Update active sessions count
    const activeCountElement = document.querySelector('.card.bg-primary .h4');
    if (activeCountElement && activeCountElement.textContent !== stats.total_active.toString()) {
        activeCountElement.textContent = stats.total_active;
    }
    
    // Update completed sessions count  
    const completedCountElement = document.querySelector('.card.bg-success .h4');
    if (completedCountElement && completedCountElement.textContent !== stats.total_completed.toString()) {
        completedCountElement.textContent = stats.total_completed;
    }
    
    // Update abandoned sessions count
    const abandonedCountElement = document.querySelector('.card.bg-warning .h4');
    if (abandonedCountElement && abandonedCountElement.textContent !== stats.total_abandoned.toString()) {
        abandonedCountElement.textContent = stats.total_abandoned;
    }
}

function updateSessionTable(type, sessions) {
    // Early return for empty completed sessions
    if (type === 'completed' && sessions.length === 0) {
        return;
    }
    
    // Find the correct table
    let tbody;
    const cards = document.querySelectorAll('.card');
    
    for (let i = 0; i < cards.length; i++) {
        const card = cards[i];
        const header = card.querySelector('.card-header h5');
        if (header) {
            if (type === 'active-abandoned' && header.textContent.includes('Current Sessions')) {
                tbody = card.querySelector('tbody');
                break;
            } else if (type === 'completed' && header.textContent.includes('Recent Completed Sessions')) {
                tbody = card.querySelector('tbody');
                break;
            }
        }
    }
    
    if (!tbody) {
        console.error('Table not found for type:', type);
        return;
    }
    
    // Generate new table HTML
    let html = '';
    
    if (sessions.length === 0) {
        const noSessionsMsg = type === 'active-abandoned' ? 
            'No active or abandoned tournaments found.' :
            'No tournaments have been completed yet.';
            
        html = `
            <tr>
                <td colspan="7" class="text-center py-4">
                    <i class="fas fa-list fa-3x text-muted mb-3"></i>
                    <h5>No ${type === 'active-abandoned' ? 'Current' : 'Completed'} Sessions</h5>
                    <p class="text-muted">${noSessionsMsg}</p>
                </td>
            </tr>
        `;
    } else {
        sessions.forEach(session => {
            if (type === 'active-abandoned') {
                html += generateActiveSessionRow(session);
            } else {
                html += generateCompletedSessionRow(session);
            }
        });
    }
    
    // Update the table content
    tbody.innerHTML = html;
}

function generateActiveSessionRow(session) {
    const statusBadge = session.status === 'ACTIVE' ? 
        '<span class="badge bg-success"><i class="fas fa-play"></i> Active</span>' :
        '<span class="badge bg-warning"><i class="fas fa-times"></i> Abandoned</span>';
        
    const rowClass = session.status === 'ABANDONED' ? ' class="table-warning"' : '';
    const buttonClass = session.status === 'ACTIVE' ? 'btn-outline-primary' : 'btn-outline-secondary';
    const roundBadge = session.status === 'ACTIVE' ? 
        `<span class="badge bg-primary">${session.round_name}</span>` :
        `<span class="badge bg-secondary">${session.round_name}</span>`;
        
    return `
        <tr${rowClass}>
            <td>${statusBadge}</td>
            <td>
                ${session.osu_username ? 
                    `<i class="fas fa-user"></i> ${session.user_display}<br><small class="text-muted">${session.osu_username}</small>` :
                    session.user_display
                }
            </td>
            <td>${roundBadge}</td>
            <td>
                ${session.status === 'ACTIVE' ? 
                    session.match_progress :
                    `<span class="text-muted">${session.match_progress}</span>`
                }
            </td>
            <td>${session.created_at}</td>
            <td>${session.updated_at}</td>
            <td>
                <a href="/game/admin/session/${session.id}/" class="btn btn-sm ${buttonClass}">
                    <i class="fas fa-eye"></i> View
                </a>
            </td>
        </tr>
    `;
}

function generateCompletedSessionRow(session) {
    return `
        <tr>
            <td>
                ${session.osu_username ? 
                    `<i class="fas fa-user"></i> ${session.user_display}<br><small class="text-muted">${session.osu_username}</small>` :
                    session.user_display
                }
            </td>
            <td>${session.updated_at}</td>
            <td>-</td>
            <td>
                <a href="/game/admin/session/${session.id}/" class="btn btn-sm btn-outline-success">
                    <i class="fas fa-trophy"></i> View Winner
                </a>
            </td>
        </tr>
    `;
}

function showUpdateNotification(message) {
    // Create notification
    const notification = document.createElement('div');
    notification.className = 'alert alert-info alert-dismissible fade show position-fixed';
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        <strong>🔄 ${message}</strong>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-hide after 3 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}

// Start real-time updates when page loads
document.addEventListener('DOMContentLoaded', function() {
    startRealTimeUpdates();
});

// Clean up when page is unloaded
window.addEventListener('beforeunload', function() {
    stopRealTimeUpdates();
});
</script>
{% endblock %}