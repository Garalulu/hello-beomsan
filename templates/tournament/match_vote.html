{% extends 'base.html' %}

{% block title %}Vote: {{ match.song1.title }} vs {{ match.song2.title }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="match-container">
            <div class="text-center mb-4">
                <h2>{{ match.tournament.name }}</h2>
                <p class="mb-0">Round {{ match.round_number }} - Match {{ match.match_number }}</p>
                {% if user_vote %}
                <div class="alert alert-info mt-2">
                    <i class="fas fa-check-circle"></i> You voted for: <strong>{{ user_vote.chosen_song.title }}</strong>
                    <br><small>You can change your vote by clicking on a different song</small>
                </div>
                {% endif %}
            </div>

            <div class="row">
                <!-- Song 1 -->
                <div class="col-md-5">
                    <div class="song-card card h-100 {% if user_vote and user_vote.chosen_song == match.song1 %}selected{% endif %}" 
                         data-song-id="{{ match.song1.id }}" onclick="selectSong('{{ match.song1.id }}')">
                        <div class="card-body text-center">
                            {% if match.song1.background_image %}
                            <img src="{% url 'serve_media' match.song1.background_image %}" 
                                 class="img-fluid rounded mb-3" style="max-height: 200px; object-fit: cover;">
                            {% endif %}
                            
                            <h4 class="card-title">{{ match.song1.title }}</h4>
                            {% if match.song1.artist %}
                            <p class="card-text text-muted">by {{ match.song1.artist }}</p>
                            {% endif %}
                            
                            <audio controls class="audio-player" preload="metadata">
                                <source src="{% url 'serve_media' match.song1.audio_file %}" type="audio/mpeg">
                                Your browser does not support the audio element.
                            </audio>
                            
                            <div class="vote-count text-primary" id="song1-votes">
                                <i class="fas fa-heart"></i> <span>{{ match.song1_votes }}</span> vote{{ match.song1_votes|pluralize }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VS Text -->
                <div class="col-md-2 d-flex align-items-center justify-content-center">
                    <div class="vs-text">VS</div>
                </div>

                <!-- Song 2 -->
                <div class="col-md-5">
                    <div class="song-card card h-100 {% if user_vote and user_vote.chosen_song == match.song2 %}selected{% endif %}"
                         data-song-id="{{ match.song2.id }}" onclick="selectSong('{{ match.song2.id }}')">
                        <div class="card-body text-center">
                            {% if match.song2.background_image %}
                            <img src="{% url 'serve_media' match.song2.background_image %}" 
                                 class="img-fluid rounded mb-3" style="max-height: 200px; object-fit: cover;">
                            {% endif %}
                            
                            <h4 class="card-title">{{ match.song2.title }}</h4>
                            {% if match.song2.artist %}
                            <p class="card-text text-muted">by {{ match.song2.artist }}</p>
                            {% endif %}
                            
                            <audio controls class="audio-player" preload="metadata">
                                <source src="{% url 'serve_media' match.song2.audio_file %}" type="audio/mpeg">
                                Your browser does not support the audio element.
                            </audio>
                            
                            <div class="vote-count text-primary" id="song2-votes">
                                <i class="fas fa-heart"></i> <span>{{ match.song2_votes }}</span> vote{{ match.song2_votes|pluralize }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-center mt-4">
                <a href="{% url 'tournament:tournament_detail' match.tournament.id %}" class="btn btn-light">
                    <i class="fas fa-arrow-left"></i> Back to Tournament
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function selectSong(songId) {
    // Remove selected class from all cards
    document.querySelectorAll('.song-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Add selected class to clicked card
    document.querySelector(`[data-song-id="${songId}"]`).classList.add('selected');
    
    // Send vote via AJAX
    fetch('{% url "tournament:cast_vote" match.id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            song_id: songId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update vote counts
            document.querySelector('#song1-votes span').textContent = data.song1_votes;
            document.querySelector('#song2-votes span').textContent = data.song2_votes;
            
            // Update pluralization
            const song1Text = data.song1_votes === 1 ? 'vote' : 'votes';
            const song2Text = data.song2_votes === 1 ? 'vote' : 'votes';
            document.querySelector('#song1-votes').innerHTML = `<i class="fas fa-heart"></i> <span>${data.song1_votes}</span> ${song1Text}`;
            document.querySelector('#song2-votes').innerHTML = `<i class="fas fa-heart"></i> <span>${data.song2_votes}</span> ${song2Text}`;
            
            // Show success feedback
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
            alertDiv.innerHTML = `
                <i class="fas fa-check-circle"></i> Vote cast successfully!
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.match-container').appendChild(alertDiv);
            
            // Auto-dismiss after 3 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        } else {
            alert('Error casting vote: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error casting vote. Please try again.');
    });
}

// Pause other audio when one starts playing
document.addEventListener('DOMContentLoaded', function() {
    const audioElements = document.querySelectorAll('audio');
    
    audioElements.forEach(audio => {
        audio.addEventListener('play', function() {
            audioElements.forEach(otherAudio => {
                if (otherAudio !== audio) {
                    otherAudio.pause();
                }
            });
        });
    });
});
</script>
{% endblock %}