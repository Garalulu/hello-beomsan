{% extends 'base/base.html' %}

{% block title %}Session Details{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-trophy"></i> Session Details</h1>
            <a href="{% url 'tournament_manage' %}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left"></i> <span class="d-none d-sm-inline">Back to Dashboard</span><span class="d-sm-none">Back</span>
            </a>
        </div>
    </div>
</div>

<!-- Session Info -->
<div class="row mb-4 g-3">
    <div class="col-12 col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> Session Information</h5>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-md-6">
                        <strong>User:</strong>
                        {% if session.user %}
                            <div class="mt-1">
                                <i class="fas fa-user"></i> {{ session.user.username }}
                                {% if session.user.profile %}
                                <br><small class="text-muted">osu!: {{ session.user.profile.osu_username }}</small>
                                {% endif %}
                            </div>
                        {% else %}
                            <div class="mt-1">
                                <i class="fas fa-user-secret"></i> Anonymous
                                <br><small class="text-muted">Session: {{ session.session_key }}</small>
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <strong>Status:</strong>
                        <div class="mt-1">
                            {% if session.status == 'COMPLETED' %}
                                <span class="badge bg-success"><i class="fas fa-check"></i> Completed</span>
                            {% elif session.status == 'ACTIVE' %}
                                <span class="badge bg-primary"><i class="fas fa-play"></i> Active</span>
                            {% elif session.status == 'ABANDONED' %}
                                <span class="badge bg-warning"><i class="fas fa-times"></i> Abandoned</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <strong>Started:</strong>
                        <div class="mt-1">{{ session.created_at|date:"M d, Y H:i" }}</div>
                    </div>
                    <div class="col-md-6">
                        <strong>Last Updated:</strong>
                        <div class="mt-1" data-last-updated>{{ session.updated_at|date:"M d, Y H:i" }}</div>
                    </div>
                </div>
                {% if session.status == 'ACTIVE' %}
                <div class="row mt-3">
                    <div class="col-md-6">
                        <strong>Current Round:</strong>
                        <div class="mt-1">
                            <span class="badge bg-primary">{{ session.get_round_name }}</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <strong>Progress:</strong>
                        <div class="mt-1" data-progress>{{ session.get_match_progress }}</div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    {% if winner_song %}
    <div class="col-12 col-lg-4">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h5><i class="fas fa-crown"></i> Tournament Winner</h5>
            </div>
            <div class="card-body text-center">
                {% if winner_song.background_image_url %}
                <img src="{{ winner_song.background_image_url }}" class="img-fluid rounded mb-3" style="max-height: 150px; max-width: 100%;">
                {% endif %}
                <h6>{{ winner_song.title }}</h6>
                {% if winner_song.original_song %}
                <p class="text-muted">Original: {{ winner_song.original_song }}</p>
                {% endif %}
                <button class="btn btn-sm btn-outline-primary" onclick="testAudio('{{ winner_song.audio_url }}')">
                    <i class="fas fa-play"></i> <span class="d-none d-sm-inline">Play</span>
                </button>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Match History -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-list"></i> Match History</h5>
            </div>
            <div class="card-body" id="match-history-container">
                {% if matches %}
                {% regroup matches by round_number as round_groups %}
                {% for round_group in round_groups %}
                <div class="mb-4">
                    <h6 class="border-bottom pb-2">
                        {% if round_group.grouper == 7 %}
                            <i class="fas fa-crown text-warning"></i> Grand-Finals
                        {% elif round_group.grouper == 6 %}
                            <i class="fas fa-trophy text-warning"></i> Finals
                        {% elif round_group.grouper == 5 %}
                            <i class="fas fa-medal text-secondary"></i> Semi-Finals
                        {% elif round_group.grouper == 4 %}
                            <i class="fas fa-award text-warning"></i> Quarter-Finals
                        {% elif round_group.grouper == 3 %}
                            <i class="fas fa-circle text-info"></i> Round of 16
                        {% elif round_group.grouper == 2 %}
                            <i class="fas fa-circle text-success"></i> Round of 32
                        {% elif round_group.grouper == 1 %}
                            <i class="fas fa-circle text-primary"></i> Round of 64
                        {% else %}
                            <i class="fas fa-circle"></i> Round {{ round_group.grouper }}
                        {% endif %}
                    </h6>
                    
                    <div class="row">
                        {% for match in round_group.list %}
                        <div class="col-12 col-lg-6 mb-3">
                            <div class="card border-light">
                                <div class="card-body p-3">
                                    <div class="row g-1">
                                        <div class="col-5">
                                            <div class="text-center p-2 {% if match.winner == match.song1 %}bg-success text-white{% endif %} rounded">
                                                <div class="fw-bold">{{ match.song1.title|truncatechars:15 }}</div>
                                                {% if match.song1.original_song %}
                                                <small class="d-none d-sm-block">{{ match.song1.original_song|truncatechars:12 }}</small>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-2 text-center align-self-center px-1">
                                            <small class="fw-bold">VS</small>
                                        </div>
                                        <div class="col-5">
                                            <div class="text-center p-2 {% if match.winner == match.song2 %}bg-success text-white{% endif %} rounded">
                                                <div class="fw-bold">{{ match.song2.title|truncatechars:15 }}</div>
                                                {% if match.song2.original_song %}
                                                <small class="d-none d-sm-block">{{ match.song2.original_song|truncatechars:12 }}</small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% if match.winner %}
                                    <div class="text-center mt-2">
                                        <small class="text-muted">Winner: <strong>{{ match.winner.title }}</strong></small>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-list fa-3x text-muted mb-3"></i>
                    <h5>No Matches Found</h5>
                    <p class="text-muted">This session has no match history.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Audio Test Modal -->
<div class="modal fade" id="audioTestModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Test Audio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <audio id="testAudio" controls class="w-100">
                    Your browser does not support the audio element.
                </audio>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Real-time session updates
let sessionData = {
    id: '{{ session.id }}',
    last_updated: '{{ session.updated_at.isoformat }}',
    total_matches: {{ matches.count }}
};

let updateInterval;
let isPageVisible = true;

// Track page visibility to pause updates when page is hidden
document.addEventListener('visibilitychange', function() {
    isPageVisible = !document.hidden;
    if (isPageVisible) {
        startRealTimeUpdates();
    } else {
        stopRealTimeUpdates();
    }
});

function startRealTimeUpdates() {
    // Clear existing interval
    if (updateInterval) {
        clearInterval(updateInterval);
    }
    
    // Update every 3 seconds
    updateInterval = setInterval(checkForUpdates, 3000);
}

function stopRealTimeUpdates() {
    if (updateInterval) {
        clearInterval(updateInterval);
        updateInterval = null;
    }
}

async function checkForUpdates() {
    if (!isPageVisible) return;
    
    try {
        const url = '{% url "session_detail_ajax" session.id %}' + '?t=' + Date.now();
        const response = await fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        
        if (!response.ok) throw new Error('Network response was not ok');
        
        const data = await response.json();
        
        if (!data.success) {
            return;
        }
        
        // Check if there are updates
        const hasUpdates = (
            data.session.updated_at !== sessionData.last_updated ||
            data.total_matches !== sessionData.total_matches
        );
        
        if (hasUpdates) {            
            updateSessionInfo(data.session);
            updateMatchHistory(data.matches);
            updateWinnerInfo(data.winner_song);
            
            // Show notification before updating tracking data
            const newMatches = data.total_matches - sessionData.total_matches;
            showUpdateNotification(newMatches);
            
            // Update tracking data
            sessionData.last_updated = data.session.updated_at;
            sessionData.total_matches = data.total_matches;
        }
        
    } catch (error) {
        console.error('Error checking for updates:', error);
    }
}

function updateSessionInfo(session) {
    // Update current round and progress
    const currentRoundElement = document.querySelector('.badge.bg-primary');
    if (currentRoundElement) {
        currentRoundElement.textContent = session.round_name;
    }
    
    const progressElement = document.querySelector('[data-progress]');
    if (progressElement) {
        progressElement.textContent = session.match_progress;
    }
    
    // Update last updated time
    const lastUpdatedElement = document.querySelector('[data-last-updated]');
    if (lastUpdatedElement) {
        const date = new Date(session.updated_at);
        lastUpdatedElement.textContent = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    }
}

function updateMatchHistory(matches) {
    const matchHistoryContainer = document.getElementById('match-history-container');
    if (!matchHistoryContainer) {
        return;
    }
    
    // Group matches by round
    const roundGroups = {};
    matches.forEach(match => {
        if (!roundGroups[match.round_number]) {
            roundGroups[match.round_number] = [];
        }
        roundGroups[match.round_number].push(match);
    });
    
    // Generate new HTML
    let html = '';
    
    if (matches.length === 0) {
        html = `
            <div class="text-center py-4">
                <i class="fas fa-list fa-3x text-muted mb-3"></i>
                <h5>No Matches Found</h5>
                <p class="text-muted">This session has no match history.</p>
            </div>
        `;
    } else {
        Object.keys(roundGroups).sort((a, b) => a - b).forEach(roundNumber => {
            const roundMatches = roundGroups[roundNumber];
            const roundName = getRoundName(parseInt(roundNumber));
            
            html += `
                <div class="mb-4">
                    <h6 class="border-bottom pb-2">${roundName}</h6>
                    <div class="row">
            `;
            
            roundMatches.forEach(match => {
                html += `
                    <div class="col-12 col-lg-6 mb-3">
                        <div class="card border-light">
                            <div class="card-body p-3">
                                <div class="row g-1">
                                    <div class="col-5">
                                        <div class="text-center p-2 ${match.winner_is_song1 ? 'bg-success text-white' : ''} rounded">
                                            <div class="fw-bold">${truncateString(match.song1_title, 15)}</div>
                                            ${match.song1_original ? `<small class="d-none d-sm-block">${truncateString(match.song1_original, 12)}</small>` : ''}
                                        </div>
                                    </div>
                                    <div class="col-2 text-center align-self-center px-1">
                                        <small class="fw-bold">VS</small>
                                    </div>
                                    <div class="col-5">
                                        <div class="text-center p-2 ${match.winner_is_song1 === false ? 'bg-success text-white' : ''} rounded">
                                            <div class="fw-bold">${truncateString(match.song2_title, 15)}</div>
                                            ${match.song2_original ? `<small class="d-none d-sm-block">${truncateString(match.song2_original, 12)}</small>` : ''}
                                        </div>
                                    </div>
                                </div>
                                ${match.winner_title ? `
                                    <div class="text-center mt-2">
                                        <small class="text-muted">Winner: <strong>${match.winner_title}</strong></small>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div></div>';
        });
    }
    
    // Update the match history content
    matchHistoryContainer.innerHTML = html;
}

function getRoundName(roundNumber) {
    const roundNames = {
        1: '<i class="fas fa-circle text-primary"></i> Round of 64',
        2: '<i class="fas fa-circle text-success"></i> Round of 32',
        3: '<i class="fas fa-circle text-info"></i> Round of 16',
        4: '<i class="fas fa-award text-warning"></i> Quarter-Finals',
        5: '<i class="fas fa-medal text-secondary"></i> Semi-Finals',
        6: '<i class="fas fa-trophy text-warning"></i> Finals',
        7: '<i class="fas fa-crown text-warning"></i> Grand-Finals'
    };
    return roundNames[roundNumber] || `<i class="fas fa-circle"></i> Round ${roundNumber}`;
}

function truncateString(str, length) {
    return str.length > length ? str.substring(0, length) + '...' : str;
}

function updateWinnerInfo(winnerSong) {
    // Update winner section if tournament is completed
    // Implementation can be added later if needed
}

function showUpdateNotification(newMatches) {
    if (newMatches <= 0) return;
    
    // Create notification
    const notification = document.createElement('div');
    notification.className = 'alert alert-success alert-dismissible fade show position-fixed';
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        <strong>🔄 Session Updated!</strong><br>
        ${newMatches} new match${newMatches > 1 ? 'es' : ''} added
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

function testAudio(audioUrl) {
    const audio = document.getElementById('testAudio');
    audio.src = audioUrl;
    
    const modal = new bootstrap.Modal(document.getElementById('audioTestModal'));
    modal.show();
    
    // Pause audio when modal is hidden
    document.getElementById('audioTestModal').addEventListener('hidden.bs.modal', function () {
        audio.pause();
    });
}

// Start real-time updates when page loads
document.addEventListener('DOMContentLoaded', function() {
    startRealTimeUpdates();
});

// Clean up when page is unloaded
window.addEventListener('beforeunload', function() {
    stopRealTimeUpdates();
});
</script>
{% endblock %}