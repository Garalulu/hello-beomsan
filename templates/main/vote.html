{% extends 'base.html' %}

{% block title %}Vote: {{ match_data.song1.title }} vs {{ match_data.song2.title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-12 col-xl-10">
            <!-- Progress Bar -->
            <div class="mb-3 mb-md-4">
                <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-2">
                    <h5 class="mb-1 mb-sm-0">{{ match_data.round_name }}</h5>
                    <small class="text-muted">Match {{ match_data.match_progress }}</small>
                </div>
                <div class="progress">
                    <div class="progress-bar" role="progressbar" style="width: {{ match_data.progress.percentage }}%">
                        <span class="d-none d-sm-inline">{{ match_data.progress.percentage }}%</span>
                    </div>
                </div>
                <small class="text-muted d-block mt-1">{{ match_data.progress.completed_matches }}/{{ match_data.progress.total_matches }} matches completed</small>
            </div>

            <!-- Match Container -->
            <div class="match-container">
                <div class="text-center mb-3 mb-md-4">
                    <h2 class="h3 h-md-2">Choose Your Favorite</h2>
                    <p class="mb-0 d-none d-sm-block">Listen to both songs and pick the one you prefer</p>
                    <p class="mb-0 d-sm-none small">Tap to choose your favorite song</p>
                </div>

                <div class="row voting-container" id="votingContainer">
                    <!-- Song 1 -->
                    <div class="col-12 col-md-5 mb-3 mb-md-0" id="song1Container">
                        <div class="song-card card h-100" data-song-id="{{ match_data.song1.id }}" onclick="selectSong('{{ match_data.song1.id }}')" 
                             onmouseover="highlightCard(this)" onmouseout="clearHighlight(this)" id="song1Card" 
                             role="button" tabindex="0" aria-label="Vote for {{ match_data.song1.title }}">
                            <div class="card-body text-center p-3">
                                {% if match_data.song1.background_image_url %}
                                <img src="{{ match_data.song1.background_image_url }}" 
                                     class="img-fluid rounded mb-3 song-image" 
                                     style="max-height: 200px; object-fit: cover; width: 100%;"
                                     alt="Background for {{ match_data.song1.title }}"
                                     loading="lazy">
                                {% else %}
                                <div class="bg-light rounded mb-3 d-flex align-items-center justify-content-center song-placeholder" 
                                     style="height: 200px; min-height: 120px;">
                                    <i class="fas fa-music fa-3x text-muted"></i>
                                </div>
                                {% endif %}
                                
                                <h4 class="card-title h5 h-md-4">{{ match_data.song1.title }}</h4>
                                {% if match_data.song1.original_song %}
                                <p class="card-text text-muted small">Original: {{ match_data.song1.original_song }}</p>
                                {% endif %}
                                
                                {% if 'drive.google.com' in match_data.song1.audio_url %}
                                <!-- Google Drive audio using iframe -->
                                <div class="audio-container mb-3" onclick="event.stopPropagation();">
                                    <iframe src="{{ match_data.song1.audio_url }}" 
                                            width="100%" height="60" frameborder="0" 
                                            allow="autoplay; encrypted-media"
                                            class="audio-player google-drive-audio"
                                            title="Audio player for {{ match_data.song1.title }}">
                                    </iframe>
                                </div>
                                {% else %}
                                <!-- Standard audio player -->
                                <audio controls class="audio-player w-100" preload="metadata" onclick="event.stopPropagation();">
                                    <source src="{{ match_data.song1.audio_url }}" type="audio/mpeg">
                                    Your browser does not support the audio element.
                                </audio>
                                {% endif %}
                                
                                <div class="mt-2 mt-md-3 text-muted">
                                    <small class="d-none d-sm-inline"><i class="fas fa-hand-pointer"></i> Click to choose this song</small>
                                    <small class="d-sm-none"><i class="fas fa-hand-pointer"></i> Tap to vote</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- VS Text -->
                    <div class="col-12 col-md-2 d-flex align-items-center justify-content-center my-2 my-md-0" id="vsContainer">
                        <div class="vs-text">VS</div>
                    </div>

                    <!-- Song 2 -->
                    <div class="col-12 col-md-5 mb-3 mb-md-0" id="song2Container">
                        <div class="song-card card h-100" data-song-id="{{ match_data.song2.id }}" onclick="selectSong('{{ match_data.song2.id }}')" 
                             onmouseover="highlightCard(this)" onmouseout="clearHighlight(this)" id="song2Card"
                             role="button" tabindex="0" aria-label="Vote for {{ match_data.song2.title }}">
                            <div class="card-body text-center p-3">
                                {% if match_data.song2.background_image_url %}
                                <img src="{{ match_data.song2.background_image_url }}" 
                                     class="img-fluid rounded mb-3 song-image" 
                                     style="max-height: 200px; object-fit: cover; width: 100%;"
                                     alt="Background for {{ match_data.song2.title }}"
                                     loading="lazy">
                                {% else %}
                                <div class="bg-light rounded mb-3 d-flex align-items-center justify-content-center song-placeholder" 
                                     style="height: 200px; min-height: 120px;">
                                    <i class="fas fa-music fa-3x text-muted"></i>
                                </div>
                                {% endif %}
                                
                                <h4 class="card-title h5 h-md-4">{{ match_data.song2.title }}</h4>
                                {% if match_data.song2.original_song %}
                                <p class="card-text text-muted small">Original: {{ match_data.song2.original_song }}</p>
                                {% endif %}
                                
                                {% if 'drive.google.com' in match_data.song2.audio_url %}
                                <!-- Google Drive audio using iframe -->
                                <div class="audio-container mb-3" onclick="event.stopPropagation();">
                                    <iframe src="{{ match_data.song2.audio_url }}" 
                                            width="100%" height="60" frameborder="0" 
                                            allow="autoplay; encrypted-media"
                                            class="audio-player google-drive-audio"
                                            title="Audio player for {{ match_data.song2.title }}">
                                    </iframe>
                                </div>
                                {% else %}
                                <!-- Standard audio player -->
                                <audio controls class="audio-player w-100" preload="metadata" onclick="event.stopPropagation();">
                                    <source src="{{ match_data.song2.audio_url }}" type="audio/mpeg">
                                    Your browser does not support the audio element.
                                </audio>
                                {% endif %}
                                
                                <div class="mt-2 mt-md-3 text-muted">
                                    <small class="d-none d-sm-inline"><i class="fas fa-hand-pointer"></i> Click to choose this song</small>
                                    <small class="d-sm-none"><i class="fas fa-hand-pointer"></i> Tap to vote</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-3 mt-md-4">
                    <a href="{% url 'home' %}" class="btn btn-light btn-sm">
                        <i class="fas fa-home"></i> <span class="d-none d-sm-inline">Back to Home</span><span class="d-sm-none">Home</span>
                    </a>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function highlightCard(cardElement) {
    cardElement.classList.add('song-card-hover');
}

function clearHighlight(cardElement) {
    cardElement.classList.remove('song-card-hover');
}

function selectSong(songId) {
    // Prevent multiple clicks during animation
    if (document.body.classList.contains('voting-in-progress')) {
        return;
    }
    
    document.body.classList.add('voting-in-progress');
    
    // Disable all cards
    document.querySelectorAll('.song-card').forEach(card => {
        card.style.pointerEvents = 'none';
    });
    
    // Start animation
    animateVoteSelection(songId);
    
    // Send vote via AJAX after 500ms to allow animation to start
    setTimeout(() => {
        fetch('{% url "cast_vote" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                session_id: '{{ match_data.session_id }}',
                chosen_song_id: songId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Add winner celebration animation after 2.5s (during the main animation)
                setTimeout(() => {
                    const selectedCard = document.querySelector(`[data-song-id="${songId}"]`);
                    if (selectedCard) {
                        const side = selectedCard.dataset.selectedSide;
                        if (side === 'left') {
                            selectedCard.classList.add('vote-animation-winner-left');
                        } else {
                            selectedCard.classList.add('vote-animation-winner-right');
                        }
                    }
                }, 2500);
                
                // Navigate after the full animation completes (4s total)
                setTimeout(() => {
                    if (data.completed) {
                        // Tournament completed
                        window.location.href = '{% url "vote" %}';
                    } else if (data.next_match) {
                        // Move to next match
                        window.location.href = '{% url "vote" %}';
                    } else {
                        // Something went wrong
                        alert('Error: No next match available');
                        window.location.href = '{% url "home" %}';
                    }
                }, 4000);
            } else {
                alert('Error casting vote: ' + data.error);
                resetVotingState();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error casting vote. Please try again.');
            resetVotingState();
        });
    }, 500);
}

function animateVoteSelection(selectedSongId) {
    const song1Card = document.getElementById('song1Card');
    const song2Card = document.getElementById('song2Card');
    const vsContainer = document.getElementById('vsContainer');
    
    // Determine which card was selected
    const song1Id = song1Card.getAttribute('data-song-id');
    const song2Id = song2Card.getAttribute('data-song-id');
    
    let selectedCard, unselectedCard;
    let isLeftCard = false;
    
    if (selectedSongId === song1Id) {
        // Left card selected
        selectedCard = song1Card;
        unselectedCard = song2Card;
        isLeftCard = true;
    } else {
        // Right card selected  
        selectedCard = song2Card;
        unselectedCard = song1Card;
        isLeftCard = false;
    }
    
    // Add appropriate animation classes based on position
    if (isLeftCard) {
        selectedCard.classList.add('vote-animation-selected-left');
        unselectedCard.classList.add('vote-animation-unselected-right');
    } else {
        selectedCard.classList.add('vote-animation-selected-right');
        unselectedCard.classList.add('vote-animation-unselected-left');
    }
    
    // Store which side was selected for the celebration animation
    selectedCard.dataset.selectedSide = isLeftCard ? 'left' : 'right';
    
    // Fade out VS container
    vsContainer.classList.add('vote-animation-vs');
    
    // Remove hover effects during animation
    selectedCard.classList.remove('song-card-hover');
    unselectedCard.classList.remove('song-card-hover');
}

function resetVotingState() {
    // Re-enable cards
    document.querySelectorAll('.song-card').forEach(card => {
        card.style.pointerEvents = 'auto';
    });
    
    // Remove voting progress flag
    document.body.classList.remove('voting-in-progress');
    
    // Remove animation classes
    const animationClasses = [
        'vote-animation-selected-left', 'vote-animation-selected-right',
        'vote-animation-unselected-left', 'vote-animation-unselected-right', 
        'vote-animation-vs',
        'vote-animation-winner-left', 'vote-animation-winner-right'
    ];
    
    document.querySelectorAll('.song-card, #vsContainer').forEach(element => {
        animationClasses.forEach(className => {
            element.classList.remove(className);
        });
        // Remove the selectedSide data attribute
        delete element.dataset.selectedSide;
    });
}

// Audio player management
document.addEventListener('DOMContentLoaded', function() {
    const audioElements = document.querySelectorAll('audio');
    const iframeElements = document.querySelectorAll('iframe.google-drive-audio');
    
    // Handle regular audio elements
    audioElements.forEach(audio => {
        audio.addEventListener('play', function() {
            audioElements.forEach(otherAudio => {
                if (otherAudio !== audio) {
                    otherAudio.pause();
                }
            });
            // Pause iframe audio (reload to stop)
            iframeElements.forEach(iframe => {
                iframe.src = iframe.src;
            });
        });
    });
    
    // Note: Google Drive iframe audio doesn't provide play/pause events
    // Users will need to manually control audio in each iframe
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Don't trigger if voting is in progress
    if (document.body.classList.contains('voting-in-progress')) {
        return;
    }
    
    if (e.key === '1' || e.key === 'ArrowLeft') {
        e.preventDefault();
        selectSong('{{ match_data.song1.id }}');
    } else if (e.key === '2' || e.key === 'ArrowRight') {
        e.preventDefault();
        selectSong('{{ match_data.song2.id }}');
    }
});
</script>
{% endblock %}